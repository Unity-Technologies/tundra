linux:
  name: "Build & Test - Linux"
  agent:
    type: Unity::VM
    image: cds-ops/cds-ubuntu-18.04-base:stable
    flavor: b1.small
  commands:
    - git submodule init
    - git submodule update
    - mono bee.exe tundra2::linux::master
    - mono bee.exe tundra2-unittest-report::linux::master
    - mono bee.exe artifacts/for-stevedore/tundra-linux-x64.zip
    - python3 -m pip install 'stevedore-upload-tool>=0.2.3'
    - python3 -m stevedoreupload --append-manifest build/linux-x86_64/manifest.stevedore --version-len=12 --glob public "$GIT_REVISION" artifacts/for-stevedore/*
  artifacts:
    artifacts:
      paths:
        - "build/**/*"

mac:
  name: "Build & Test - Mac"
  agent:
    type: Unity::VM::osx
    image: buildfarm/mac:stable
    flavor: m1.mac
  commands:
    # TODO: It should be possible to procure a Mac image that has both Mono and Python 3 preinstalled.
    - HOMEBREW_NO_AUTO_UPDATE=1 HOMEBREW_NO_INSTALL_CLEANUP=1 brew upgrade python || true
    - git submodule init
    - git submodule update
    - mono bee.exe tundra2::mac::master
    - mono bee.exe tundra2-unittest-report::mac::master
    - mono bee.exe artifacts/for-stevedore/tundra-mac-x64.zip
    - python3 -m pip install 'stevedore-upload-tool>=0.2.3'
    - python3 -m stevedoreupload --append-manifest build/osx-x86_64/manifest.stevedore --version-len=12 --glob public "$GIT_REVISION" artifacts/for-stevedore/*
  artifacts:
    artifacts:
      paths:
        - "build/**/*"

windows:
  name: "Build & Test - Windows"
  agent:
    type: Unity::VM
    image: cds-ops/win10-base:stable
    flavor: b1.small
  commands:
    # TODO: It should be possible to procure a Windows image that has Python 3 preinstalled.
    - choco install --no-progress -y python3 -source https://artifactory.bf.unity3d.com/artifactory/api/nuget/unity-choco-local
    - git submodule init
    - git submodule update
    - bee.exe tundra2::win::master
    - bee.exe tundra2-unittest-report::win::master
    - bee.exe artifacts/for-stevedore/tundra-win-x64.zip artifacts/for-stevedore/tundra-win-x64-debug.7z
    - py -3 -m pip install "stevedore-upload-tool>=0.2.3"
    - py -3 -m stevedoreupload --append-manifest build/windows-x86_64/manifest.stevedore --version-len=12 --glob public "%GIT_REVISION%" artifacts/for-stevedore/*
  artifacts:
    artifacts:
      paths:
        - "build/**/*"

package:
  name: "Package Distribution"
  agent:
    type: Unity::VM
    image: cds-ops/cds-ubuntu-18.04-base:stable
    flavor: b1.small
  commands:
    - sudo apt install -y p7zip
    - git submodule init
    - git submodule update
    - 7za a -tzip builds.zip * -xr\!unittest/googletest/.git
    - echo 'Stevedore artifacts uploaded:' && sort build/*/manifest.stevedore
  artifacts:
    artifacts:
        paths:
        - builds.zip
  triggers:
    branches:
      only:
      - "/.*/"
  dependencies:
    - .yamato/yamato-ci.yml#linux
    - .yamato/yamato-ci.yml#mac
    - .yamato/yamato-ci.yml#windows
